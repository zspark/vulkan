#ifndef _HEADER_GLFW_UTILS_
#define _HEADER_GLFW_UTILS_
/*
#define CHECK_BOOL(fn, msg)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    \
    if (!(fn)) {                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               \
        if (msg)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               \
            fprintf(stderr, msg);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              \
        exit(EXIT_FAILURE);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    \
    }
    */

#include <optional>
#include <stdio.h>

#define GLFW_INCLUDE_VULKAN
#include <GLFW/glfw3.h>

#include <vulkan/vulkan.h>

static bool _glfwInited = false;
static bool _init() {
    if (!glfwInit()) {
        fprintf(stderr, "[GLFW] init failed.\n");
        return false;
    }
    glfwWindowHint(GLFW_CONTEXT_VERSION_MAJOR, 2);
    glfwWindowHint(GLFW_CONTEXT_VERSION_MINOR, 0);

    /**
     * When using Vulkan with GLFW, you need to create a GLFW window with the GLFW_NO_API hint, indicating that the window won't be used with OpenGL. Vulkan does not require an OpenGL context, and specifying GLFW_NO_API helps GLFW set up the window appropriately for Vulkan.
     * Set GLFW to not create an OpenGL context, if not, there will be a error like: `Error: Vulkan: Window surface creation requires the window to have the client API set to GLFW_NO_API`;
     */
    glfwWindowHint(GLFW_CLIENT_API, GLFW_NO_API);
    _glfwInited = true;
    return true;
}

static void _errorCallback(int error, const char *description) { fprintf(stderr, "[GLFW]Error: %s\n", description); }

static void _keyCallback(GLFWwindow *window, int key, int scancode, int action, int mods) {
    fprintf(stdout, "Key pressed, key:%d, scancode:%d, action:%d, mods:%d\n", key, scancode, action, mods);
    if (key == GLFW_KEY_ESCAPE && action == GLFW_PRESS)
        glfwSetWindowShouldClose(window, GLFW_TRUE);
}

namespace utils {
static bool createWindow(const char *caption, GLFWwindow **a, uint32_t w = 640u, uint32_t h = 480u) {
    if (!_glfwInited && (!_init())) {
        fprintf(stderr, "failed to init glfw library!\n");
        return false;
    }

    GLFWwindow *_wnd = glfwCreateWindow(w, h, caption, NULL, NULL);
    if (!_wnd) {
        fprintf(stderr, "failed to create glfw window!\n");
        glfwTerminate();
        return false;
    }

    glfwSetKeyCallback(_wnd, _keyCallback);
    glfwSetErrorCallback(_errorCallback);

    /*
     * vulkan application does NOT need these:
     * glfwMakeContextCurrent(_wnd);
     * glfwSwapInterval(1);
     */

    *a = _wnd;
    return true;
}

/**
 * graphicsFamily:
 * The graphicsFamily typically represents the queue family that is responsible for handling graphics commands and rendering tasks in Vulkan.
 * Commands related to graphics processing, such as drawing and rendering, are submitted to a queue associated with the graphics family.
 *
 * presentFamily:
 * The presentFamily refers to the queue family that is responsible for presenting the rendered images to the screen or the window surface.
 * In Vulkan, after rendering a frame, the images need to be presented to the display. The presentFamily is associated with the queue that handles this presentation process.
 */
struct CapableQueueFamilies {
    std::optional<uint32_t> graphicsFamilyIndex = std::nullopt;
    std::optional<uint32_t> presentFamilyIndex = std::nullopt;

    bool isComplete() const { return graphicsFamilyIndex.has_value() && presentFamilyIndex.has_value(); }
};

struct vulkanContext {
    VkInstance ins{VK_NULL_HANDLE};
    VkPhysicalDevice phyDev{VK_NULL_HANDLE};
    VkSurfaceKHR surface{VK_NULL_HANDLE};
    CapableQueueFamilies indices;
    VkDevice dev{VK_NULL_HANDLE};
    VkSwapchainKHR swapChain{VK_NULL_HANDLE};
    std::vector<VkImage> vecSwapChainImage;
    std::vector<VkImageView> vecSwapChainImageView;
    VkDebugUtilsMessengerEXT debugMessenger{VK_NULL_HANDLE};
};

struct SwapChainSupportDetails {
    VkSurfaceCapabilitiesKHR capabilities;
    std::vector<VkSurfaceFormatKHR> formats;
    std::vector<VkPresentModeKHR> presentModes;
};

static void destroyContext(vulkanContext &ctx) {
    for (auto iv : ctx.vecSwapChainImageView) {
        vkDestroyImageView(ctx.dev, iv, nullptr);
    }
    if (ctx.swapChain) {
        vkDestroySwapchainKHR(ctx.dev, ctx.swapChain, nullptr);
    }
    if (ctx.surface) {
        vkDestroySurfaceKHR(ctx.ins, ctx.surface, nullptr);
    }
    if (ctx.dev) {
        vkDestroyDevice(ctx.dev, nullptr);
    }
    if (ctx.debugMessenger) {
        auto vkDestroyDebugUtilsMessengerEXT = (PFN_vkDestroyDebugUtilsMessengerEXT)vkGetInstanceProcAddr(ctx.ins, "vkDestroyDebugUtilsMessengerEXT");
        vkDestroyDebugUtilsMessengerEXT(ctx.ins, ctx.debugMessenger, nullptr);
    }
    if (ctx.ins) {
        vkDestroyInstance(ctx.ins, nullptr);
    }
}

} // namespace utils

#endif
